# Main entrypoint of the workflow. 
# Please follow the best practices: 
# https://snakemake.readthedocs.io/en/stable/snakefiles/best_practices.html,
# in particular regarding the standardized folder structure mentioned there. 

configfile: "../config.yaml"

# rule all
rule all:
  input: 
	"./results/downloaded_data.fna"

# rule efetch
rule efetch:
  input:
	"../.test/example_data/test_accession.txt"
  output:
	"./results/downloaded_data.fna"
  conda: 
	"./envs/download.yaml"
  script: 
	"python3 ./scripts/efetch_fasta.py < {input} > {output}"

# rename_fasta_records
rule rename_fasta_records:
  # Renames the record names in the multi-fasta to avoid problems 
  # with whitespaces or too long names in certain tools.
  # Creates a backup of the original record names: .bak file.
  input:
  	"./results/downloaded_data.fna"
  output:
  	"./results/accessions_renamed.fna"
  shell:
  	"sed 's/\.[0-9].*//g' {input} > {output}"

# rule split_multifasta
rule split_multifasta:
  input: 
    "./results/downloaded_data.fna"
  output: 
    "../results/split_output"
  conda:
    "envs/biopyton.yaml"
  script:
    "python3 scripts/split_multifasta.py -f {input} -d {output}"

# rule pharokka:
rule pharokka:
  input: 
    "../results/split_output/{accession_id}.fasta"
  output: 
    "../results/pharokka/{accession_id}"
  threads: config["threads"]
  log: "workflow/logs/pharokka.log"
  conda: "env/pharokka.yaml"
  shell:
	  "pharokka -i {input} -l {{wildcards.accession_id}##*_} -o {output} -p {wildcards.accession_id} -t {threads} &> {log}"



